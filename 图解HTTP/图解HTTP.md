# 图解HTTP

## 第一章 了解Web及网络基础
### 1.1 使用HTTP协议访问web

- 通过发送请求获取服务器资源的Web浏览器等，都可以称为**客户端(client)**
![][image-1]

### 1.3 网络基础TCP/IP
通常使用的网络（包括互联网）是在TCP/IP协议族的基础运作的。而HTTP属于它内部的一个子集。
#### 1.3.2 TCP/IP的分层管理
TCP/IP协议族按层次分为

- 应用层
	-  决定了向用户提供应用服务时通信的活动（例如FTP(File Transfer Protocol)/DNS(Domain Name System)等）
	- HTTP协议处于该层
- 传输层
	- 对上层应用层，提供了网络连接中的两台计算机之间的数据传输
	- 传输层有两个性质不同的协议：TCP(Transmission Control Protocol)和UDP(User Data Protocol)
- 网络层
	- 用来处理在网络上流动的数据包（是网络传输的最小数据）。
	- 规定了通过怎样的路径（就是传输路线）到达对方计算机，并把数据包传送给对方
- 数据链路层
	- 用来处理连接网络的硬件部分。包括控制操作系统、硬件的设备驱动、NIC（网卡），及光纤等物理课件部分。硬件范畴均在链路层。

#### 1.3.3 TCP/IP 通信传输流
![][image-2]

利用TCP/IP协议族进行网络通信时，会通过分成顺序与对方进行通信。  
发送端从应用层往下走，接收端则往上走。  

**封装**：发送端在层与层之间的传输数据时，每经过一层时必定会被打上一个改层所属的首部信息。反之，接收端在层与层传输数据时，每经过一一层时，会把对应的首部消去。

### 1.4 与HTTP关系密切的协议:IP、TCP和DNS
#### 1.4.1 负责传输的IP协议
IP（Internet Protocol）网际协议位于网络层 ，是协议名称，有别于IP地址 
作用就是把各种数据包传送给对方，为确保传送到对方那里，需要满足条件，其中两个重要的条件是IP地址和MAC地址

- IP地址指明了节点分配的地址（可变换）
- MAC地址指的是网卡所属的固定地址（基本不会改）
- 使用ARP协议凭借MAC地址进行通信
- IP间的通信以来MAC地址，因为通信双方在同一个局域网内的情况很少，在进行中转时，会利用下一站中转设备的MAC地址来搜索下一个中转目标。
	- 这时采用ARP协议（Address Resolution Protocol），是一种用以解析地址的协议，根据通信方的IP地址就可以反查出对应的MAC地址。

![][image-3]

#### 1.4.2 确保可靠性的TCP协议
桉层次分，TCP位于传输层，提供可靠的字节流服务。
也就是，TCP协议为了更容易传送大数据才把数据分割，而且TCP协议能够确认数据最终是否送达到对方。

为了准确无误地将数据送达目标处，TCP协议采用了**三次握手**策略。（使用了TCP的标准——SYN（synchronize）和ACK（acknowledge））

- 发送端首先发送一个带SYN标志的数据包给对方
- 接收端收到后回传一个带有SYN/ACK标志的数据包以示传达确认信息
- 发送端再回传一个带ACK标准的数据包，代表握手结束

### 1.5 负责域名解析的DNS服务
DNS（Domain Name System）服务是和HTTP协议一样位于应用层的协议。提供域名和IP地址之间的解析服务。  
用户通常通过主机名或域名来访问对方的计算机，而不是直接通过IP地址。  
计算机不理解名称，更擅长处理一长串数字。  
DNS协议提供通过域名查找IP地址，或逆向从IP地址反查域名的服务

### 1.6 各种协议与HTTP协议的关系
![][image-4]

### 1.7 URI 和URL
与URI（统一资源标识符）相比，我们更熟悉URL（Uniform Resource Locator，统一资源定位符）。
#### 1.7.1 URI 统一资源标识符
URI = Uniform Resource Identifier  
URI用字符串标识某一互联网资源，而URL表示资源的地点（互联网上所处的位置）。URL是URI的子集。


#### 1.7.2 URI格式

- 绝对URI
	- 使用http或者https等协议方案名获取访问资源时要指定协议类型。最后附一个冒号：
- 绝对URL
- 相对URL：指从浏览器中基本URI处指定的URL，形如/image/logo.gif
- …

## 第二章 简单的HTTP协议
### 2.1 HTTP协议用于客户端和服务器端之间
应用HTTP协议时，必定一端是客户端，一端是服务器端。

### 2.2
HTTP协议规定，请求从客户端发出，最后服务器端响应请求并返回。服务器端在没有接到请求之前是不会发送响应的。
![][image-5]

请求报文：  

- 方法（method）：GET/POST
- 请求URI（request-URI）：e.g /index.htm
- HTTP版本号，用来提示客户端使用的HTTP协议功能。 e.g HTTP/1.1
- (可选)请求首部字段
- (可选)内容实体

![][image-6]

响应报文：

- HTTP版本号
- 状态码
- 状态码的原因短语
- (可选)创建响应的日期时间，是首部字段内的一个属性
- (可选)主体

### 2.3 HTTP是不保存状态的协议
HTTP是一种不保存状态的协议，即无状态协议。HTTP协议自身不对请求和响应之间的通信状态进行保存。  
为了保存状态功能，引入了Cookie技术。

### 2.4 请求URI定位资源
URI的特定功能，在互联网上任意位置的资源都能访问到。  
HTTP协议使用URI让客户端定位资源  
当客户端请求访问资源而发送请求时，URI需要将作为请求报文中的请求URI包含在内。如果不是访问特定资源，而是对服务器本身发起请求，可以用一个\*来代替URI。`OPTIONS * HTTP/1.1`

### 2.5 告知服务器意图的HTTP方法
HTTP/1.1中可以使用的方法：

- GET：获取资源
- POST： 传输实体主体
- PUT：传输文件 （不带验证机制，存在安全问题。一般不使用）
- HEAD：获得报文首部
	- 和GET方法一样，只是不返回报文主题部分。
	- 用于确认URI的有效性及资源更新的日期时间等

- DELETE：删除文件
	- 与PUT相反，按请求URI删除指定的资源
	- 同样带验证机制，存在安全问题。一般不使用

- OPTIONS：询问支持的方法
	- 查询针对请求URI指定的资源支持的方法
![][image-7]

- TRACE:追踪路径
	- 不常用，容易引发XST攻击（跨站追踪）
- CONNECT：要求用隧道协议链接代理
	- 要求在与代理服务器通信时建立隧道，实现用隧道协议进行TCP通信。主要使用SSL和TLS协议把通信内容加密后经网络隧道传输

### 2.7 持久连接节省通信量
只要任意一端没有明确提出断开连接，则保持TCP连接状态

#### 2.7.2 管线化：
持久连接使得多数请求以管线化方式发送成为可能。以前发送请求后需要等待并收到响应才能发生下一个请求。管线化技术的出现，不用等待响应亦可直接发送下一个请求。这样可以同时并行发送多个请求。

### 2.8 使用Cookie的状态管理
Cookie会根据从服务器端发送的响应报文内的一个叫做Set-Cookie的首部字段信息，通知客户端保存Cookie。当下次客户端再往该服务器发送请求时，客户端会自动在报文中加入Cookie值发送出去。  
服务器端发现客户端发送过来的Cookie后，检查从哪一个客户端发来的连接请求，然后对比服务器的记录，最后得到之前的状态信息。

## 第三章 HTTP报文内的HTTP信息
### 3.1 HTTP报文
HTTP报文大致可分为报文首部和报文主体两块。两者由最初出现的空行（回车符➕换行符）来划分。不一定要有报文主体。

- 报文首部：服务器端或者客户端需处理的请求或响应的内容及属性
- 报文主体：应被发送的数据

### 3.2 请求报文及响应报文的结构

- 请求行/状态行
	- 请求行：包含用于请求的方法，请求URI和HTTP版本
	- 状态行：包含表明响应结果的状态码，原因短语和HTTP版本

- 首部字段：包含请求和新颖的各种条件和属性的各类首部
	- 通用首部
	- 请求首部
	- 响应首部
	- 实体首部
	- （可能包含HTTP和RFC里未定义的首部（Cookie等））。

### 3.3编码提升传输速率
#### 3.3.1 报文主体和实体主体的差异

- 报文（message）
	- HTTP通信的基本单位
	- 8位组字节流组成
	- 通过HTTP通信传输

- 实体（entity）
	- 作为请求或者响应的有效载荷数据（补充项）被传输，其内容由实体首部和实体主体组成

HTTP报文的主体用于传输请求或者响应的实体主体。  
通常，报文主体等于实体主体。  
只有当传输中进行编码操作时，实体主体的内容发生变化，才有差异。

#### 3.3.2 压缩传输的内容编码
HTTP协议中有一种被称为内容编码的功能也能进行类似ZIP压缩的操作。  
内容编码指明应用在实体内容上的编码格式，并保持实体信息原样压缩。  
内容编码后的实体由客户端接收并且负责解码。  
常见内容编码有以下几种： 

- gzip
- compress
- delate
- identity

#### 3.3.3 分割发送的分块传输编码
在HTTP通信过程中，请求的编码实体资源尚未全部传输完成之前，浏览器无法显示请求页面。  
在传输大容量数据时，通过把数据分割成多块，能够让浏览器逐步显示页面。  
这种把实体主体分块的功能称为分块传输编码。

#### 3.4 发送多种数据的多部分对象集合
HTTP协议中采用了多部分对象集合，发送一份报文主体内可含有多类型的实体。通常是在图片或文本文件等上传时使用。  
多部分对象集合包含的对象如下：

- multipart/form-data
	- 在Web表单文件上传使用
- multipart/byterangers
	- 状态码206（Partial Content，部分内容）响应报文包含了多个范围的内容时使用。
![][image-8]
![][image-9]

在HTTP报文中使用多部分对象集合时，需要在首部字段里加上`Content-type`  
使用boundary字符串来划分多部分对象集合指明的各类实体。 在各个实体的起始行之前插入“\-\-”标记(例如：\-\-AaB03x-\-、-\-THIS\_STRING\_SEPARATES-\-）作为结束

### 3.5 获取部分内容的范围请求
以前不使用高速网络，如果下载网络中断就必须重新开始。为解决这个问题，需要一种可恢复机制。  
要实现该功能需要指定下载的实体范围。  
指定范围发送的请求叫做范围请求（range request）  

执行范围请求时，会用到`Range`来指定资源的byte范围。

	byte范围的指定形式如下：
	        5001~10000字节
	        Range:bytes=5001~10000
	        从5001字节之后全部的
	        Range: byte=5001-
	        从一开始到3000字节和5000~7000字节的多重范围
	        Range: byte=-3000, 5000-7000

针对范围请求，响应会返回状态码206 Partial Content的响应报文。  
对于多重范围的范围请求，响应会在首部字段`Content-Type`标明`multipart/byteranges`后返回响应报文  
如果服务器无法响应范围请求，则会但会状态码200 OK和完整的实体内容。

### 3.6 内容协商返回最合适的内容
同一个web网站可能保存多份相同内容的页面。比如英语版和中文版的WEB页面，内容虽相同，语言却不同。  
但浏览器的默认语言为英语或中文，访问相同URI的web页面时，则会显示对应的英语版或者中文版。这样的机制成为**内容协商（Content Negotiation）**  

内容协商机制是指客户端和服务器端就响应的资源内容进行交涉，然后提供给客户端最为适合的资源，内容协商会以响应资源的语言、字符集、编码方式等作为判断的基准。

包含在请求报文中的某些首部字段就是判断基准：

- Accept
- Accept-Charset
- Accept-Encoding
- Accept-Language
- Content-Language

内容协商技术有以下3种类型：

- 服务器驱动协商（server-driven Negotiation）
	- 以请求的首部字段为参考，在服务器自动处理。但不一定是最优内容
- 客户端驱动协商（agent-driven negotiation）
	- 用户从浏览器显示的可选项列表手动选择。还可以利用JavaScript脚本在web页面上自动进行上述选择。例如按OS的类型或者浏览器类型，自行切换成PC版网页或手机版网页
- 透明协商（Transparent Negotiation）
	- 两种的结合体。各自进行内容协商的一种方法。

## 第四章 返回结果的HTTP状态码
HTTP状态码负责表示客服端HTTP请求的返回结果、标记服务器端的处理是否正常、通知出现的错误等工作。

状态码的第一位指定了响应类别。   
状态码的类别：

- 1XX（Informational 信息性） 接收的请求正在处理
- 2XX （Success 成功状态码）请求正常处理完毕
- 3XX （Redirection 重定向状态码）需要进行附加操作以完成请求
- 4XX （Client Error 客户端错误状态码）服务器无法处理请求
- 5XX （Server Error 服务器错误状态码）服务器处理请求出错

### 4.2 2XX 成功 success
请求正常处理完毕

- 200 OK 
	- 表示从客服端发来的请求在服务器端被正常处理了

在响应报文内，随状态码一起返回的信息会因方法的不同而发生变化。  
使用GET方法时，对应请求资源的实体会作为响应返回。  
使用HEAD方法时，对应请求资源的实体首部不随报文主体作为响应返回。（即在响应中只返回首部，不会返回实体的主体部分）

- 204 No Content
	-  请求处理成功！但没有资源可返回。
	- 一般在只需要从客户端往服务器发送信息，而对客户端不需要发送新信息内容的情况下使用。

- 206 Partial Content
	- 表示客户端进行了范围请求，而服务器成功执行了这部分的GET请求。
	- 响应报文中包含由Content-Range指定范围的实体内容。

### 4.3 3XX 重定向 redirection
表明浏览器需要执行某些特殊的处理以正确处理请求

- 301 Moved Permanently
	- 永久性重定向
	- 请求的资源以及被分配了新的URI，以后应使用资源现在所指定的URI。
	- 如果以及把URI保存为书签，这时应该按Locaiton首部字段提示的URI重新保存
	- 例如这个路径最后忘记添加‘/’,就会产生301状态码`http://example.com/sample`

- 302 Found
	- 临时性重定向
	- 表示请求的资源已被分配了新的URI，希望用户（本次）能使用新的URI访问
	- 与301对比，302是临时性的，已移动的资源对应的URI将来还有可能发生改变。
	- 用户把URI保存成书签，但不会像301状态码那样去更新书签，而是仍旧保留返回302状态码的页面对应的URI

- 303 See Other
	- 表示由于请求对应的资源存在着另一个URI，应使用GET方法定向获取请求的资源。
	- 303和302有着相同的功能，但303明确表示客户端应当采用GET方法获取资源。

当301、302、303响应状态码返回时，几乎所有浏览器都会把POST改成GET，并删除请求报文内的主体，之后请求会自动再次发送。  
301、302标准是禁止将POST改变成GET方法的，但实际使用时大家都会这么做。

- 304 Not Modified
	- 表示客户端发送附带条件的请求时，服务器端允许请求访问资源，但未满足条件的情况。
	- 304返回时，不包含任何响应的主体部分。
	- 304虽然被划分在3XX类别中，但是和重定向没有关系。

- 307 Temporary Redirect
	- 临时重定向。与302有相同含义，尽管302标准禁止POST变换成GET,但大家并不遵守。
	- 307会遵守浏览器标准，不会从POST变成GET。但是，对于处理响应时的行为，每种浏览器有可能出现不同的情况。

### 4.4 4XX客户端错误 client error
表明客户端是发生错误的原因所在。

- 400 Bad Request
	- 表示请求报文中存在语法错误。
	- 当错误发生时，需修改请求的内容后再次发送请求。
	- 浏览器会像200 OK一样对待该状态码。

- 401 Unauthorized 
	- 表示发送的请求需要有通过HTTP认证的认证信息。
	- 若之前已经进行过1次请求，则表示用户认证失败。
	- 返回含有401的响应必须包含一个适用于被请求资源的WWW-Authenticate首部用以质询用户信息。初次接到401响应时，会弹出认证用的对话窗口。

- 403 Forbidden
	- 表明对请求资源的访问被服务器拒绝了。
	- 没有必要给出拒绝的详细理由，可以在实体的主体部分对原因进行描述

- 404 Not Found
	- 表明服务器上无法找到请求的资源。
	- 也可以再服务器端拒绝请求且不想说吗理由时使用。

### 4.5 5XX服务器错误
表明服务器本身发生错误。

- 500 Internal Server Error
	- 表明服务器端在执行请求时发生了错误。
	- 也有可能是Web应用存在的bug或者某些临时的故障

- 503 Service Unavailable
	- 表明服务器暂时处于超负载或者正在进行停机维护，现无法处理请求。
	- 如果事先知道解决以上状况需要的世界，最好写入RetryAfter首部字段再返回给客户端。

状态码和状况的不一致。不少返回的状态码响应都是错误的。

## 第五章 与HTTP协作的Web服务器
一台Web服务器可搭建多个独立域名的web网站，也可作为通信路径上的中转服务器提升传输效率。

### 5.1 用单台虚拟主机实现多个域名
即使只有一台服务器，只要使用虚拟主机的功能，则可以假想已具有多台服务器。

若两个网站同时部署在同一个服务器上（相同的IP地址），使用DNS服务解析域名后，两者的访问IP地址会相同。  
因此在发送HTTP请求时，必须在Host首部内完整指定主机名或域名的URI。

### 5.2 通信数据转发程序：代理、网关、隧道
HTTP通信时，除客户端和服务器以外，还有一些用于通信数据转发的应用程序，例如代理、网关、隧道。它们可以配合服务器工作。

- 代理：
	- 有转发功能的应用程序，扮演了中间人的角色在服务器和客户端中。
	- 每次通过代理服务器转发请求或响应时，会追加写入Via首部信息以标记出经过的主机信息。
	- 使用代理的理由：
		- 利用缓存技术减少网络带宽的流量
		- 组织内部针对特定网站的访问控制
		- 以获取访问日志为主要目的
	- 使用代理的方法：
		- 一种是是否使用缓存
		- 另一种是是否会修改报文
	- 透明代理：不对报文做任何加工的代理类型。
- 网关：
	- 转发其他服务器通信数据的服务器，像自己拥有资源的源服务器一样对请求进行处理。有时客户端可能都不会察觉，自己的通信目标是一个网关。
	- 能提高通信的安全性（例如网站用信用卡结算，网关可以和信用卡结算系统联动）
- 隧道：
	- 隧道是在相隔甚远的客户端和服务器两者之间进行中转，并保持双方通信连接的应用程序。
	- 使用SSL等加密手段进行通信。确保客户端与服务器进行安全的通信。
	- 不会去解析HTTP请求，原样中转。隧道会在通信双方断开连接时结束。

### 5.3 保存资源的缓存
缓存是指代理服务器或客户端本地磁盘内保存的资源副本。  
可减少对源服务器的访问，节省了通信流量和通信时间。

缓存服务器是代理服务器的一种，并归类在缓存代理类型中。但代理转发从服务器返回的响应时，代理服务器将会保存一份资源的副本。  
请求的资源如果已经被缓存则直接由缓存服务器返回给客户端。  
有缓存有效期限

客户端的缓存。存在客户端浏览器中。但判定缓存过期后，会向源服务器确认资源的有效性。若判断浏览器缓存失败，浏览器会再次请求新资源。

[image-1]:	1.png
[image-2]:	2.png
[image-3]:	3.png
[image-4]:	4.png
[image-5]:	5.png
[image-6]:	6.png
[image-7]:	7.png
[image-8]:	8.png
[image-9]:	9.png